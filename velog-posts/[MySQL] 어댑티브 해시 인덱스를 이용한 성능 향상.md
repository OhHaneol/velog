<h2 id="📍-어댑티브-해시-인덱스adaptive-hash-index란">📍 어댑티브 해시 인덱스(Adaptive Hash Index)란?</h2>
<p>쉽게 말해서 데이터 페이지를 메모리(버퍼 풀) 내에서 접근하는 것을 더 빠르게 만드는 기능이다.</p>
<p>기존 인덱싱 기법 중 하나인 <code>B-Tree</code>의 경우 <code>root-branch-leaf</code>와 같이 각 노드를 거치는 과정에서 CPU 성능이 하락할 수 있다.
<code>어댑티브 해시 인덱스</code>는 <strong>자주 읽히는 데이터 페이지</strong>를 대상으로 해시 인덱스를 생성하여 원하는 페이지를 즉시! 찾아갈 수 있는 기능으로 CPU(사용 감소) 및 쿼리(처리량 증가)의 성능을 향상시킬 수 있다.
둘을 비교하자면 한 쿼리당 페이지 접근에 대해 어댑티브 해시 인덱스가 3배 효율적이라고도 할 수 있다.</p>
<p>물론 이는 버퍼 풀에 올려진 데이터 페이지에 대해서만 관리된다.</p>
<h2 id="📍-성능-향상">📍 성능 향상</h2>
<p>어댑티브 해시 인덱스가 언제나 성능을 향상시키는 것은 아니다. 어댑티브 해시 인덱스 또한 메모리를 사용하며, 때로는 상당히 큰 메모리 공간을 사용할 수도 있다.
어댑티브 해시 인덱스가 성능 향상에 도움이 되는 경우와 되지 않는 경우를 알아보자.</p>
<h3 id="성능-향상에-도움이-되는-경우">성능 향상에 도움이 되는 경우</h3>
<ol>
<li>디스크의 데이터가 InnoDB 버퍼 풀의 크기와 비슷한 경우(디스크 읽기가 많지 않음)</li>
<li>동등 조건 검색이 많은 경우</li>
<li>쿼리가 데이터 중에서 일부 데이터에만 집중되는 경우</li>
</ol>
<p>주로 좁은 범위와 메모리 내의 데이터 조회와 관련이 있다.</p>
<h3 id="성능-향상에-도움이-되지-않는-경우">성능 향상에 도움이 되지 않는 경우</h3>
<ol>
<li>디스크 읽기가 많은 경우</li>
<li>Like 등 특정 패턴의 쿼리가 많은 경우</li>
<li>매우 큰 데이터를 가진 테이블의 레코드를 폭 넓게 조회하는 경우</li>
</ol>
<p>주로 넓은 범위와 디스크 내의 데이터 조회와 관련이 있다.</p>
<h3 id="판단하는-방법">판단하는 방법</h3>
<p>어댑티브 해시 인덱스는 일단 활성화 될 경우 그 키 값이 해시 인덱스에 있든 없든, 검색해봐야 한다. 즉 해시 인덱스의 효율이 없더라도 InnoDB 는 계속 해시 인덱스를 사용할 것이다.
또한 <strong>테이블의 삭제와 변경 작업</strong>을 할 때에도, InnoDB 스토리지 엔진은 이 테이블이 가진 모든 데이터 페이지의 내용을 어댑티브 해시 인덱스에서 제거해야 한다. 이 과정에서 <strong>많은 CPU 자원을 사용하고, 그만큼 데이터베이스 서버의 처리 성능이 느려진다.</strong></p>
<p><strong>그렇다면 언제 활성화해야 하는 걸까?</strong> 정확한 판단을 위한 가장 쉬운 방법은 MySQL 서버의 상태 값들을 살펴보는 것이다.</p>
<pre><code class="language-sql">mysql&gt; SHOW ENGINE INNODB STATUS\G
...
N hash searches/s, M non-hash searches/s</code></pre>
<p>여기서 N은 어댑티브 해시 인덱스를 사용한 경우, M은 사용하지 못한 경우를 말한다. 즉,</p>
<ul>
<li>어댑티브 해시 인덱스 히트율 = N / (N+M)</li>
</ul>
<p>이러한 경우, 어댑티브 해시 인덱스 히트율과 서버의 CPU 사용량을 종합해서 판단하도록 한다.</p>
<p>예시 1. CPU 사용량이 100% 에 근접해서 서버가 바쁜데, 히트율이 28% 정도로 적당히 효율이 있다? -&gt; 활성과 OK!
예시 2. CPU 사용량이 그다지 높지 않은데 히트율이 28% 정도이다? -&gt; 어댑티브 해시 인덱스의 메모리 사용량이 높을 경우 오히려 비활성화하여 InnoDB 의 버퍼 풀이 더 많은 메모리를 사용하도록 유도하는 것이 좋다!</p>
<p>이 때 어댑티브 해시 인덱스의 메모리 사용량은 다음처럼 <code>performance_schema</code>를 이용해서 확인할 수 있다.</p>
<pre><code class="language-sql">mysql&gt; SELECT EVENT_NAME, CURRENT_NUMBER_OF_BYTES_USED 
        FROM performance_schema, memory_summary_global_by_event_name 
        WHERE EVENT_NAME='memory/innodb/adaptive hash index';</code></pre>
<h2 id="📑-참고-자료">📑 참고 자료</h2>
<ul>
<li>Real MySQL 8.0 1권</li>
</ul>