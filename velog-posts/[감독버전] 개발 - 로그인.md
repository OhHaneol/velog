<h1 id="ğŸ“-ê°œë°œ-ìˆœì„œ">ğŸ“ ê°œë°œ ìˆœì„œ</h1>
<ul>
<li>ë¡œê·¸ì¸ modelê³¼ dto ì‘ì„±</li>
<li>í† í° modelê³¼ ìƒìˆ˜ ì‘ì„±</li>
<li>í† í° 1ì°¨ Service êµ¬í˜„</li>
<li>ë¡œê·¸ì¸ Service êµ¬í˜„</li>
<li>ë¡œê·¸ì¸ Controller êµ¬í˜„</li>
<li>í† í° 2ì°¨ Service êµ¬í˜„ : resolverë¥¼ ì´ìš©í•œ ì‚¬ìš©ì ì¸ì¦ ì ìš©</li>
</ul>
<h1 id="ğŸ“-ê°œë°œ">ğŸ“ ê°œë°œ</h1>
<h2 id="1-ë¡œê·¸ì¸-modelê³¼-dto-ì‘ì„±">1. ë¡œê·¸ì¸ modelê³¼ dto ì‘ì„±</h2>
<h3 id="authuser-ëª¨ë¸-ì‘ì„±">AuthUser ëª¨ë¸ ì‘ì„±</h3>
<p><code>src/main/java/ohahsis/dailydirector/auth/model/AuthUser.java</code></p>
<pre><code class="language-java">@Data
public class AuthUser {
    private final Long id;

    public Long getId() {
        return this.id;
    }
}</code></pre>
<h3 id="ë¡œê·¸ì¸-ìš”ì²­-dto-ì‘ì„±">ë¡œê·¸ì¸ ìš”ì²­ dto ì‘ì„±</h3>
<p><code>src/main/java/ohahsis/dailydirector/auth/dto/request/AuthLoginRequest.java</code></p>
<pre><code class="language-java">@Data
public class AuthLoginRequest {
    private String email;
    private String password;
}</code></pre>
<h3 id="ë¡œê·¸ì¸-ì‘ë‹µ-dto-ì‘ì„±">ë¡œê·¸ì¸ ì‘ë‹µ dto ì‘ì„±</h3>
<p><code>src/main/java/ohahsis/dailydirector/auth/dto/request/AuthLoginResponse.java</code></p>
<pre><code class="language-java">@Data
@AllArgsConstructor
public class AuthLoginResponse {
    private String nickname;
    private String token;
}</code></pre>
<h2 id="2-í† í°-modelê³¼-ìƒìˆ˜-ì‘ì„±">2. í† í° modelê³¼ ìƒìˆ˜ ì‘ì„±</h2>
<h3 id="jwt-secret-key-ë“±ë¡">jwt secret key ë“±ë¡</h3>
<p><code>src/main/resources/application.yml</code></p>
<pre><code class="language-yml">jwt:
  secret:
    key: (ìƒì„±í•œ ì½”ë“œ ì‘ì„±)</code></pre>
<ul>
<li>key ìƒì„± ë°©ë²•<ul>
<li>ë§¥ì—ì„œ ì§„í–‰í•˜ê¸° ë•Œë¬¸ì— í„°ë¯¸ë„ì—ì„œ openSSL ëª…ë ¹ì–´ë¡œ ìƒì„±í–ˆë‹¤.</li>
<li>ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ë©´ í‚¤ê°€ ìƒì„±ëœë‹¤.<pre><code class="language-shell">    openssl rand -hex 64</code></pre>
</li>
</ul>
</li>
</ul>
<h3 id="authtoken-ëª¨ë¸-ì‘ì„±">AuthToken ëª¨ë¸ ì‘ì„±</h3>
<p><code>src/main/java/ohahsis/dailydirector/auth/model/AuthToken.java</code></p>
<pre><code class="language-java">@Data
public class AuthToken {
    private final String key;
    private final String token;

    public AuthToken(String token) {
        this.key = AUTH_TOKEN_HEADER_KEY;
        this.token = token;
    }
}
</code></pre>
<h3 id="í† í°-ìƒìˆ˜-ì‘ì„±">í† í° ìƒìˆ˜ ì‘ì„±</h3>
<p><code>src/main/java/ohahsis/dailydirector/auth/AuthConstants.java</code></p>
<pre><code class="language-java">public class AuthConstants {
    public static final String AUTH_TOKEN_HEADER_KEY = "X-FP-AUTH-TOKEN";
}</code></pre>
<h2 id="3-í† í°-1ì°¨-service-êµ¬í˜„">3. í† í° 1ì°¨ Service êµ¬í˜„</h2>
<h3 id="tokenservice-v1-êµ¬í˜„">TokenService V1 êµ¬í˜„</h3>
<p><code>src/main/java/ohahsis/dailydirector/auth/application/TokenService.java</code></p>
<pre><code class="language-java">@Slf4j
@Component
@RequiredArgsConstructor
public class TokenService {
    private final UserRepository userRepository;
    private String key;

    @Value("${jwt.secret.key}")
    public void getSecretKey(String secretKey) {
        key = secretKey;
    }

    // login api ì— ì ìš©
    public String jwtBuilder(Long id, String nickname) {
        Claims claims = Jwts.claims();
        claims.put("nickname", nickname);
        claims.put("uid", id);
        Date now = new Date();
        return Jwts.builder()
                .setClaims(claims)
                // TODO : ìœ íš¨ê¸°ê°„ ì„¤ì •ì€ ë‹¤ìŒ MVCì—ì„œ ì§„í–‰í•œë‹¤.
                // .setExpiration(new Date(now.getTime() + accessTokenValidMillisecond))
                .signWith(SignatureAlgorithm.HS256, key.getBytes())
                .compact();
    }
}</code></pre>
<ul>
<li>í´ë ˆì„(Claim): í† í°ì— ë‹´ì„ í•˜ë‚˜ì˜ ì •ë³´, í•œ ì¡°ê°ì˜ ì •ë³´ë¥¼ í´ë ˆì„ì´ë¼ê³  í•œë‹¤. í´ë ˆì„ì€ í‚¤-ê°’ ì˜ í•œ ìŒìœ¼ë¡œ ì´ë£¨ì–´ì ¸ìˆë‹¤.</li>
</ul>
<h2 id="4-ë¡œê·¸ì¸-service-êµ¬í˜„">4. ë¡œê·¸ì¸ Service êµ¬í˜„</h2>
<h3 id="authservice-êµ¬í˜„">AuthService êµ¬í˜„</h3>
<p><code>src/main/java/ohahsis/dailydirector/auth/application/AuthService.java</code></p>
<pre><code class="language-java">@Service
@RequiredArgsConstructor
public class AuthService {
    private final UserRepository userRepository;
    private final TokenService tokenService;

    public AuthLoginResponse login(AuthLoginRequest request) {
        var user = userRepository.findByEmailAndPassword(request.getEmail(), request.getPassword())
                .orElseThrow(() -&gt; new AuthLoginException(ErrorType.FAIL_TO_LOGIN_ERROR));
        var token = tokenService.jwtBuilder(user.getId(), user.getNickname());

        return new AuthLoginResponse(user.getNickname(), token);
    }
}</code></pre>
<h3 id="authloginexception-ì˜ˆì™¸-ë“±ë¡">AuthLoginException ì˜ˆì™¸ ë“±ë¡</h3>
<pre><code class="language-java">public class AuthLoginException extends BusinessException {
    public AuthLoginException(ErrorType errorType) {
        super(errorType);
    }
}</code></pre>
<h2 id="5-ë¡œê·¸ì¸-controller-êµ¬í˜„">5. ë¡œê·¸ì¸ Controller êµ¬í˜„</h2>
<h3 id="authcontroller-êµ¬í˜„">AuthController êµ¬í˜„</h3>
<p><code>src/main/java/ohahsis/dailydirector/auth/presentation/AuthController.java</code></p>
<pre><code class="language-java">@RestController
@RequestMapping(path = "/api/auth", produces = MediaType.APPLICATION_JSON_VALUE)
@RequiredArgsConstructor
public class AuthController {
    private final AuthService authService;

    @PostMapping("/login")
    public ResponseEntity&lt;?&gt; login(@RequestBody AuthLoginRequest request) {
        var response = authService.login(request);
        return ResponseDto.ok(response);
    }
}</code></pre>
<h3 id="ì‘ë‹µ-dto-ì‘ì„±">ì‘ë‹µ dto ì‘ì„±</h3>
<pre><code class="language-java">@Data
@AllArgsConstructor
@NoArgsConstructor(access = AccessLevel.PROTECTED) 
public class ResponseDto&lt;T&gt; implements Serializable { 
    private T data;

    public static &lt;T&gt; ResponseEntity&lt;ResponseDto&lt;T&gt;&gt; ok(T data) {
        return ResponseEntity.ok(new ResponseDto&lt;T&gt;(data));
    }

    public static &lt;T&gt; ResponseEntity&lt;ResponseDto&lt;T&gt;&gt; created(T data) {
        return ResponseEntity.status(HttpStatus.CREATED).body(new ResponseDto&lt;T&gt;(data));
    }

    public static ResponseEntity&lt;Void&gt; noContent() {
        return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
    }
}</code></pre>
<h2 id="6-í† í°-2ì°¨-service-êµ¬í˜„--resolverë¥¼-ì´ìš©í•œ-ì‚¬ìš©ì-ì¸ì¦-ì ìš©">6. í† í° 2ì°¨ Service êµ¬í˜„ : resolverë¥¼ ì´ìš©í•œ ì‚¬ìš©ì ì¸ì¦ ì ìš©</h2>
<h3 id="tokenservice-v2-êµ¬í˜„">TokenService V2 êµ¬í˜„</h3>
<p><code>src/main/java/ohahsis/dailydirector/auth/application/TokenService.java</code></p>
<pre><code class="language-java">@Slf4j
@Component
@RequiredArgsConstructor
public class TokenService {
    private final UserRepository userRepository;
    private String key;

    @Value("${jwt.secret.key}")
    public void getSecretKey(String secretKey) {
        key = secretKey;
    }

    public void verifyToken(String token) {
        // í† í°ì„ íŒŒì‹±í•´ì„œ í•´ë‹¹ í† í°ì„ ì–»ê³ , í† í°ì´ ë§Œë£Œë˜ì—ˆìœ¼ë©´ ì—ëŸ¬ ë°œìƒì‹œí‚´
        try {
            Jwts.parser().setSigningKey(key.getBytes()).parseClaimsJws(token);
        } catch (Exception e) {
            if (e.getMessage().contains("JWT expired")) {
                throw new AuthorizationException(ErrorType.AUTHORIZATION_ERROR);
            }
            throw new AuthorizationException(ErrorType.AUTHORIZATION_ERROR);   
        }

        Long uid = getUserIdFromToken(token);   // token ìœ¼ë¡œ ìœ ì €ì˜ id ë¥¼ ì°¾ì•„ì„œ
        if (!userRepository.existsById(uid)) {  // id ë¡œ DB ì¡°íšŒë¥¼ í†µí•´ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            throw new AuthorizationException(ErrorType.AUTHORIZATION_ERROR);
        }
    }

    // login ì™¸ íƒ€ api ì—ì„œ AuthUser ê²€ì¦ ì‹œ ì ìš©
    public AuthUser getAuthUser(AuthToken token) {
        verifyToken(token.getToken());  // í† í° ê´€ë ¨ ë¬¸ì œê°€ ìƒê¸¸ ê²½ìš° error
        var id = getUserIdFromToken(token.getToken());
        var user =
                userRepository
                        .findById(id)
                        .orElseThrow(
                                () -&gt; new AuthorizationException(ErrorType.AUTHORIZATION_ERROR));
        return new AuthUser(id);
    }

    public Long getUserIdFromToken(String token) {
        return Long.valueOf(
                (Integer)
                        Jwts.parser()
                                .setSigningKey(key.getBytes())
                                .parseClaimsJws(token)
                                .getBody()
                                .get("uid"));
    }

    // login api ì— ì ìš©
    public String jwtBuilder(Long id, String nickname) {
        Claims claims = Jwts.claims();
        claims.put("nickname", nickname);
        claims.put("uid", id);
        Date now = new Date();
        return Jwts.builder()
                .setClaims(claims)
                // TODO : ìœ íš¨ê¸°ê°„ ì„¤ì •ì€ ë‹¤ìŒ MVCì—ì„œ ì§„í–‰í•œë‹¤.
                // .setExpiration(new Date(now.getTime() + accessTokenValidMillisecond))
                .signWith(SignatureAlgorithm.HS256, key.getBytes())
                .compact();
    }
}</code></pre>
<h3 id="authorizationexception-ì˜ˆì™¸-ë“±ë¡">AuthorizationException ì˜ˆì™¸ ë“±ë¡</h3>
<pre><code class="language-java">public class AuthorizationException extends BusinessException {
    public AuthorizationException(ErrorType errorType) {
        super(errorType);
    }
}</code></pre>
<h3 id="userargumentresolver-êµ¬í˜„">UserArgumentResolver êµ¬í˜„</h3>
<p><code>src/main/java/ohahsis/dailydirector/config/resolver/UserArgumentResolver.java</code></p>
<pre><code class="language-java">@Component
@RequiredArgsConstructor
public class UserArgumentResolver implements HandlerMethodArgumentResolver {
    private final TokenService tokenService;


    // íŒŒë¼ë¯¸í„° íƒ€ì…ì— AuthUser ê°€ ìˆìœ¼ë©´ ì¡ì•„ì±„ì„œ ë™ì‘í•˜ëŠ” resolver

    @Override
    public boolean supportsParameter(MethodParameter parameter) {   // ê°œë…: í•´ë‹¹ ë©”ì„œë“œì˜ ë§¤ê°œë³€ìˆ˜ì— ëŒ€í•´, í•´ë‹¹ resolver ê°€ ì§€ì›í•˜ëŠ” ê²ƒì¸ì§€ë¥¼ ì²´í¬í•œë‹¤.
        return parameter.getParameterType().equals(AuthUser.class); // ì‚¬ìš©: íŒŒë¼ë¯¸í„°ê°€ AuthUser.class ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©´ true ë¥¼, ì•„ë‹ˆë©´ false ë¥¼ ë°˜í™˜
    }

    @Override
    public Object resolveArgument(                                  // ê°œë…: ë§¤ê°œë³€ìˆ˜ë¡œ ë„£ì–´ì¤„ ê°’ì„ ì œê³µí•œë‹¤.
            MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory) throws Exception {
        var httpServletRequest = (HttpServletRequest) webRequest.getNativeRequest();

        var accessToken = httpServletRequest.getHeader(AUTH_TOKEN_HEADER_KEY);  // request ì˜ í—¤ë”ì—ì„œ í† í°ì„ êº¼ë‚¸ë‹¤.

        if (accessToken == null) {
            if (parameter.isOptional()) {
                return null;
            }
            accessToken = "";
        }

        var token = new AuthToken(accessToken);

        return tokenService.getAuthUser(token);                     // ì‚¬ìš©: token ì„ í†µí•´ ì–»ì€ AuthUser ê°ì²´ë¥¼ ë°˜í™˜í•œë‹¤.
    }
}</code></pre>
<ul>
<li><code>Argument Resolver</code><ul>
<li>ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì„œë“œì˜ íŒŒë¼ë¯¸í„° ì¤‘ íŠ¹ì • ì¡°ê±´ì— ë§ëŠ” íŒŒë¼ë¯¸í„°ê°€ ìˆë‹¤ë©´, ìš”ì²­ì— ë“¤ì–´ì˜¨ ê°’ì„ ì´ìš©í•´ ì›í•˜ëŠ” ê°ì²´ë¥¼ ë§Œë“¤ì–´ ë°”ì¸ë”©í•´ì¤„ ìˆ˜ ìˆë‹¤.</li>
</ul>
</li>
</ul>
<h3 id="userargumentresolver-ë“±ë¡">UserArgumentResolver ë“±ë¡</h3>
<p><code>src/main/java/ohahsis/dailydirector/config/web/WebConfig.java</code></p>
<pre><code class="language-java">@Configuration
@RequiredArgsConstructor
public class WebConfig implements WebMvcConfigurer {
    private final UserArgumentResolver userArgumentResolver;

    @Override
    public void addArgumentResolvers(List&lt;HandlerMethodArgumentResolver&gt; resolvers) {
        resolvers.add(userArgumentResolver);
    }
}
</code></pre>
<h1 id="ğŸ“-ê²°ê³¼">ğŸ“ ê²°ê³¼</h1>
<h3 id="ë¡œê·¸ì¸-ì„±ê³µ-ê²€ì¦">ë¡œê·¸ì¸ ì„±ê³µ ê²€ì¦</h3>
<img alt="img" src="https://velog.velcdn.com/images/otyvs1109/post/e0d55a18-d9f2-43cc-a362-37eefa3e17fe/image.png" width="600" />

<h3 id="ì´ë©”ì¼-ì˜¤ë¥˜-ê²€ì¦">ì´ë©”ì¼ ì˜¤ë¥˜ ê²€ì¦</h3>
<img alt="img" src="https://velog.velcdn.com/images/otyvs1109/post/25aec66a-2a5a-4591-bc27-4984cff8c142/image.png" width="600" />

<h3 id="ë¹„ë°€ë²ˆí˜¸-ì˜¤ë¥˜-ê²€ì¦">ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜ ê²€ì¦</h3>
<img alt="img" src="https://velog.velcdn.com/images/otyvs1109/post/6ebd590e-e49e-4bba-833d-70e6be678303/image.png" width="600" />

<hr />
<h2 id="ë‹¤ìŒìœ¼ë¡œ">ë‹¤ìŒìœ¼ë¡œ</h2>
<ul>
<li>ê¸€ì“°ê¸° api ë¥¼ êµ¬í˜„í•´ë³´ì.</li>
</ul>